<p>上学的时候就想着搭建一个服务器，用来做自己的私人网盘，备份个文件会很方便，不管是百度云还是阿里云（我相信它不会一直不限速）速度都太慢了，除此之外还可以做，git仓库，maven仓库等，跑一些程序。但是我毕业了才做这个事，毕竟上学时候的钱也不多。搭建的时候遇到了许多小问题，在此记录一下。</p>
<p>我并没有选择购买云服务器，虽然像腾讯云可能一百多就能买一年的服务器，但是带宽很低上传下载软件就很力不从心，磁盘扩展的成本好像也不是很低。在一次刷b站的时候，偶然看到了一个买小主机做软路由的博主，我突然发现是不是也可以买个小主机做服务器啊。不搜不知道一搜吓一跳，一个4核1.8主频的小主机才五百多块钱，但是没有内存和硬盘，我秉着勤俭节约的想法，在闲鱼精心挑选了一个小主机，8g的固态硬盘，一个1t的机械盘，一个128g的固态盘，加在一起不过才800多。显示器和键盘我自己有，服务器也不需要这些，所以没有额外再买。</p>
<p>我这个服务器是要搭在我家里的，但是有了硬件设备，还需要公网ip才行，家庭宽带一般给的都是nat转发的运营商的城域内网ip，一般是10开头的，192开头的是小型家庭内网ip。在网上搜了一下解决方法，主要有三种1. 内网穿透，使用一个有公网ip的服务器转发流量，使用花生壳这样的平台，这样肯定不行，流量成本太高，网速也很垃圾，还不如我自己买个云服务器。2. 使用ipv6，目前ipv6运营商给家庭宽带分配的都是公网ip，ipv6目前手机移动网络从19年开始，智能手机已经全面支持了，路由器家庭路由现在的都支持，有些需要自己手动开启一下，企业级别的路由器目前很少有支持的。这个方案很不错，但是我在公司没有ipv6这个也不完全行。3. 向运营商申请动态的公网ip，我家里只有移动和联通的，去镇上问了一下，移动是肯定不支持的，它的公网ipv4太少了，联通有，但是说我们这个县已经用完了，电信我也问了下，说只要我装他们的宽带就给我一个，这还的花钱，于是我投诉了一下我们县的联通宽带，没想到真有用，顺利拿到了联通的动态公网ipv4。现在我拥有一个联通的动态ipv4公网ip，两个（联通和移动都支持）公网的ipv6。</p>
<p>解决完硬件和公网ip问题后，就开始搭服务器了，我给小主机安装unbutu系统，连接移动和联通两个宽带，这样这个小主机就拥有了三个可以访问的公网ip。我在上面搭建了文件服务器，maven仓库，git仓库，定时脚本（爬一些可以爬取的信息），软件开发的测试环境等等。使用上可扩展性还是很强的，还可以作为监控系统的视频保存主机。</p>
<p>到这里搭建使用看起来很顺利，但是中间还是遇到了很多小问题，这些小问题有的还真的花了我很多，折腾了很久，有些软件或者硬件可能本身就有问题，一般的书籍课本根本不会讲现在的这些设备或者协议的关系，就比如路由器，现在的路由器根本不可能只是路由器这么简单；下面我来列举一下这些问题或者知识。</p>
<ol>
<li>家庭宽带的80，433端口是不能用的。</li>
<li>运营商送的光猫服务器默认是不允许外部网络主动请求，只允许内部设备ip主动向外请求，需要关闭这个防火墙功能才行。</li>
<li>使用运营商送的路由器直接连接设备，网络下的每个设备都有自己的公网ipv6，ipv6的ip也是动态的，但是ipv4的ip只有光猫是公网的，连接设备的依然只能是内网的192.168这些。所以需要做nat，或者叫dmz，或者叫防火墙，或者叫端口转发，让外部主动访问的流量主动访问到某个具体的内部主机，运营商送的路由器没有这个功能，所以我选择了把一个老的路由器刷成openwrt软路由（一个开源的路由器系统），让运营商的光猫路由器做桥接，用这个opwnert路由器来直接连接运营商得到动态的公网ipv4，然后转发到内部具体的主机。</li>
<li>不要让自己的ip或者域名发布到网络上，如果发布，要使用端口映射或者防火墙，不要直接使用dmz模式，要保持着安全风险意识。</li>
<li>网络设备的基本知识：
<ol>
<li>一个网卡只能有且只有一个ip（可以同时有多个不同协议的ip，看设备是否支持）</li>
<li>一个电脑的ip指的是，虚拟设备的ip，有些虚拟设备没有概念概念只是功能。这个ip的值，可以自己设置，也可以让电脑的dhcp客户端主动向服务器的dhcp服务器获取。路由器的ip，比如电信的192.168.1.1就是他给自己用于向内部设备转发流量的网卡设置的固定ip，也会记录自己dhcp服务器给下发设备分配的ip。</li>
<li>一个路由器至少需要两个网卡，一个用于连接上由运营商的路由，一个用于连接家庭内部的设备。同时支持联通电信上网的路由器需要三个网卡。</li>
<li>一个路由器，或者linux系统，winndows系统，使用ifconfig命令查看的是网络设备，不是网卡，网络设备分为，和物理一对一的设备，具有抽象功能软件的设备，不对应真实的物理设备，也不能说是虚拟网卡，也有可能只是集线器的功能，这些设备用于系统程序的使用。</li>
<li>一个路由器的wan口对应着一个网卡，多个lan口其实是只是一个集线器或者交换机，他们共同对应着一个网卡（无线wifi也可以看作一个lan口，同样在这个集线器上）。</li>
</ol>
</li>
<li>路由器的运行模式有：
<ol>
<li>桥接：就是直接当作网线用了</li>
<li>中继：需要两个网卡，一个用于接收ip流量，一个用于作为ip流量口转发</li>
<li>路由：一个网卡接口直接连接运营商网络的中继模式。</li>
</ol>
</li>
<li>openwrt知识：
<ol>
<li>设备：就是前面说的含义，其中，br-lan指的就是那个多个lan口的集线器。eth对应着一个真实的物理设备</li>
<li>接口：其实是控制器，用于选择多个设备，控制他们的软件功能参数。一个设备可以有多个接口共同提供设备。</li>
<li>无线：要看有几个无线连接物理器，可以发起连接和发布热点，然后选择一个wan类型的设备，把流量转发上去。如果物理设备不够，无法同时连接多个wifi会失败的。</li>
<li>openwrt会把lan（br-lan)类型的设备和wan类型的设备（多个，比如多个eth设备，进行连接，使用他们上面的接口器的配置做出处理（这些配置都是openwrt提供的）。这些配置也叫协议。</li>
<li>防火墙：将wan设备的接口集合，和lan接口集合（一般就一个br-lan）作为一个整体做端口转发映射。</li>
<li>openwrt做二级路由的时候，给下级设备分配ipv6的ip，这个时候就是中继模式，需要提供一个ipv4接口（dhcp客户端，因为这个接口就是客户端），一个ipv6接口（设置为dhcpv6客户端），共同设备一个上游路由器的设备，其中ipv6设备的接口要设置允许ipv6长度，ipv6的相关配置协议选项都设置为中继模式，选中学习路由。然后将lan相关的接口，其中的一个ipv6相关协议，dhcp设置为服务器模式，其他协议都设置为中继模式（这样作为服务器，给下级设备提供ipv6的ip，不给自己给，而是通过另外两个协议向上级dhcp服务器索要）。如果不做二级路由直接让光猫路由器作为中继模式，自己连接运营商就不用这么麻烦。</li>
<li>由于公网ip不管是ipv4还是ipv6都是动态的，所以需要一个ddns功能，可以申请腾讯云或者花生壳的域名，都支持ddns，然后在openwrt安装一个动态ddns插件，其中腾讯云的需要额外安装腾讯云动态ddns脚本才可以。</li>
</ol>
</li>
<li>运营商送的光猫路由器我发现有些电信的是有问题的，关闭防火墙就无法使用dhcpv6了，这样做的目的难道是禁止外部通过ipv6访问主机？不关吧，就无法通过外部公网访问内部ip。也有可能我遇到的光猫是有问题的。</li>
<li>运营商送的路由器改桥接，需要登录路由器才行，而且需要超级密码，联通会直接给，移动和电信大家可以去网上搜下获取的办法。</li>
</ol>
