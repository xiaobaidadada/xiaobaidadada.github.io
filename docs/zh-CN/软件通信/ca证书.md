# 加密算法

加密算法太多了，我们从解密加密的方式来看，大概有这三种。

1. 对称加密：就是使用同一个密钥字符串，进行解密和加密操作。des,aes
2. 非对称加密：是一对密钥，使用其中一个加密，必须使用另一个才能解密。一般会把这说成，公钥和私钥，其实没有严格的区分，这对密钥，把谁公布出去，谁就可以叫公钥。rsa,dsa
3. hash不可逆加密：就是hash算法，java的map，python的字典，就是这么做的，不可逆，数据结构还可以用来做数组下标。



# CA证书



我们知道，自己想让自己开发的网站，后台可以使用https，就要给自己的域名申请ca证书。其实这个证书，本质上就是一个字符串，包括以下这些内容：

1. 公钥，申请证书的人的公钥，不是必须的，但是一般肯定会有，因为像https这样的请求会用到。
2. 发证书机构的基本信息。必须有
3. **发证书机构的公钥，必须有**
4. 申请这个证书的人的信息。。。格式不固定
5. 过期时间，不是必须的
6. 父证书：。。。套娃，和上面的内容一样，形成证书链，如果下级越多，颁发证书的级别越低，证书文件就会越大。
7. **对以上内容的签名，**不包括自己。这个签名就是sign。一般http请求也有签名，就是对body进行hash，生成一个字符串。在服务器同样hash验证一下内容是否被修改。这里的签名就是对除了签名字符串以外前面所有信息字符串的签名，这个签名不是用hash，而是用和签名公钥成对的私钥加密生成的字符串。这个私钥只属于，发证书的机构。前面的内容是明文的，所以我们可以用发证书的公钥，去解密这个签名信息，如果得到的信息和证书中其它明文的信息一模一样，就说明证书内容是真实的没有被修改的。

非对称很难被破解，所以可以认为是无法直接破解的。所以我们可以得出一个结论，使用证书中的公钥对签名进行解密，如果内容一样，就是没有被修改的。

**上面，签名（机构私钥签的，私钥未知），机构的公钥。这两部分最重要。**

# 浏览器怎么使用CA证书



1. 当请求是https的时候，就会向服务器索要ca证书了。

2. 浏览器默认会在电脑上安装一些顶级机构的证书，我们也可以自己安装。

3. 浏览器向服务器索要ca证书，我们的服务器上的证书，比如是从腾讯云购买的，浏览器下载了这个证书，就会先使用证书中的机构公钥验证证书有没有被修改。
4. 如果没有被修改，就会判断，这个证书机构的信息，和自己电脑上安装的证书中的机构信息是否一样，如果一样就认为服务器是权威认证实名过的。
5. 如果没有匹配上，就会查看证书中的父证书信息，对这个父证书信息做4的操作判断，验证整个证书链，只要有一个匹配到自己电脑上安装的任意一个证书就通过。
6. 通过以后，浏览器会使用证书中的另一个公钥，服务器的公钥，向服务器发送加密请求信息。



# 微信支付使用到的证书

## 请求需要什么

1. 向支付中心申请一个字符串密钥。
2. 我们自己需要申请一个ca证书，申请方式是向微信申请，这个证书的作用是微信需要认证请求者是合法的，因为支付安全非常重要，只用一个字符串密钥不够安全。此时对于微信来说，我们就是一个网站，我们想请求微信，就必须要弄https，也就是ca证书证明自己（前面已经说了为什么）。不仅会给我们证书，还会给一个私钥。私钥不在证书中，证书中只有公钥。
3. 商户信息。
4. 回调地址
5. 其它参数

其实最重要的，也是最麻烦的就是第一个，证书。申请到了证书，实际请求微信的接口，不用把整个证书发给微信，把证书序列号给他就行，他会自己查找这个证书，因为就是腾讯给的证书，然后我们用申请证书对应的私钥对请求的http的内容，整个加密，也就是前面，把这个字符串放到http的header头中一起发送。



微信支付，接受到这个请求，就像服务器给浏览器发送公钥数据一样，微信此时作为浏览器的身份，首先利用证书序列号找证书，然后用证书序列号中的公钥（我们自己私钥的另一半），去解密http请求头中的heard头中的前面，得到的结果和实际的内容一致，就算通过了验证（这是最主要的验证，当然还有其它商户号，参数验证）；



## 接受需要什么

1. 需要微信证书

我们请求完微信，微信会用回调的方式给我们响应。

但是微信给的内容是加密过的。有些人把这个叫报文。我们这个时候，怎么解密这个数据呢，我们可以把自己当浏览器，接收到服务器的https数据，我们就要用服务器的证书，给的公钥，去解密数据。

微信支付官网就可以下载它的ca证书，然后拿到证书中的公钥（我们可以选择不验证，直接用一些工具提取，只要你确定这个证书是真实的从微信官网下载的），他好像五年更新一次。

这是主麻烦的解密一步，实际内容还需要其它参数一起解密并验证。



## 实际

微信支付有很多sdk，在请求这一步，给sdk我们自己的私钥，他就会自动为我们的请求体做签名放到请求头。

在接受到这一步，根据微信给的证书的序列号，去官网下载，并自动更新，剩下就是解密验证了。



所以，如果没有sdk，手动用post这样的工具去请求，我们需要做的事还挺多的。



