# 软件通信模型

软件通信模型，由于多个程序之间，可能不在一个进程内运行，甚至不在一个电脑上运行，他们之间的数据交互方式，就是软件通信模型。

有一个名词叫做RPC(Remote Procedure Call，远程过程调用)，它的含义只是指的是，一个进程，直接从从另一个进程，执行一个函数，并返回结果。这是一种，假设程序在一起，抽象可以直接调用另一个远程的函数进行通信的方式。开发业务功能，通常会用到这种通信方式，因为这么做逻辑性是最强的。

本篇文章说的是，消息队列的通信模型。如果将软件通信限定为，两个程序之间的通信，那么就只有两种行为，一种是类似RPC的，一种就是消息队列形式的，消息队列形式的肯定会有一个中间服务程序，叫做broker，用来转发数据，或者叫消息。

1. 直接通信的，适合实时业务要求高的，必须立即返回。
2. 消息队列形式的，适合网络不佳，或者数据量太大，不需要实时，可以异步。



# 实际的消息队列软件

下面每个协议或者软件，都会从消费方式，和ack支持，来分析特点和问题。ack是消息确认机制，这对于保证消息执行成功，重复消费问题都是有帮助的（**这里只讨论消费者的ack，因为生产者的ack都是自动的**）。消息中间件软件，通常都支持消息的持久化，重启后依然可以保留之前的消息。broker 一般都有可视化界面管理。

消息队列，肯定都是发布订阅模型的。

## MQTT 

这是一个协议，具体实现的开源软件有很多，比如MQTTX，它的功能非常少，因此消息头很短(tcp通信，必须要定义数据包的协议头)，适合于物联网通信。他是一个非常简单的发布订阅模型，**一般用于物联网实时通信**。

它只支持，主题，订阅与发布。发布者可以有多个，订阅者也可以有多个，从订阅到的那一刻开始，都会接收到同样的消息。

1. 消费方式： 就是普通的消费方式。自动ack完就会处理下一个消息。没有消费者组的概念。
2. ack: mqtt支持三种级别的通信等级，q1,q2会进行自动ack，不允许手动的，q2可能会出现重复消费。q1没有ack可能会丢失消息。



## KAFKA

这是一个消息软件。之前的版本需要zookeeper，最新的不需要了。这个软件的功能就比mqtt的要多了，所以它底层的协议头肯定要大些。它的发布订阅模型，主题还可以具体分区。发送消息，可以指定发送到主题（也就发送给了所有分区），也可以选择一个主题内的分区。消费者可以组成消费者组，组内只能有一个消费者。这样就默认，每个独立的消费者都是一个消费者组。**主题和分区的最小消费单元是消费者组。**

他还支持批量操作，保证了吞吐量，就是一次接受和处理多个顺序的消息。

它适合，对数据处理有分类要求的场景。大数据，日志分类收集，数据分类实时计算分析等。

1. 消费方式：  有消费者组的概念。
2. ack：支持自动，也支持手动的，自动的可能会出现消费重复消费的问题，它的自动ack没有mqtt的严格，超时后，就会重试发送消息。手动的，有消息偏移量的概念，就是消息的前后顺序坐标，手动ack需要提交下一个消息的位置，一般就是+1，不提交完就不消费。如果设置了消费者组，长时间没有ack的，可能会给别的消费者重试，还是可能出现重复消费，就看怎么配置了，比较灵活。





## RABBITMQ

rabbitMQ 是AMQP(Advanced Message Queuing Protocol) 协议的实现软件。实现AMQP协议的软件有很多，但是大部分都有一些额外的功能，rabbitmq就是为了实现amqp。

这种软件的功能是，提供一些消息自动的识别处理功能，这样功能更加多，更适合开发业务功能。还有插件机制。

它的发布订阅模型，更加丰富，需要先创建交换机，每一个交换机，都是一个转发消息的与生产者有关系的组件。每个队列用于接受交换机的消息。队列和交换机要进行绑定，绑定的时候要指定，交换机转发的规则（每个交换机都有类型，只规定了类型，但是具体参数还是要指定的）。

每个消息还可指定各种头信息，路由键，交换机主要依靠这些信息做路由。

交换机和队列必须提前创建，当然也可以用一些选项，让他自动创建，然后还要绑定交换机。

消息可以直接发送到一个队列，也可以发送到一个交换机，让交换机自己判断发送到哪个队列。

还提供了通道功能，可以把多个通道看作多个tcp连接客户端（本质上是一个连接），实际场景很少用到这个，没有什么需要两个客户端的场景。

1. 消费方式：一个消费者，可以消费一个或者多个队列。没有消费者组的功能，想要这个功能恐怕要利用路由来实现了，或者使用竞争消费模式，只有一个消费。
2. ack： 默认需要手动进行ack确认，确认已经消费完成，然后继续下一个消息。如果使用了自动模式，就会有重复消费的可能，还没做完，就重试发送第二次处理了。



## rocketMq

这个mq，不是amqp，只是消息订阅模型，有主题，需要订阅，但是消息允许有消息头，可以添加定义许标签，消费者可以根据这些东西过滤判断要不要消费，还提供了消费者组的功能，延迟消费，也有自动ack和手动ack。目前我还没使用过，用官网介绍和例子上看，就是一个功能性比较强的消费队列，比rabbitmq在概念上更简单了，功能又更多。

